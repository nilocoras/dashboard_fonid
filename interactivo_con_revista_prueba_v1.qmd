---
title: "FONID - Nivel Primario (2018-2023)"
format:
  dashboard:
    scrolling: true
    theme: Lumen
server: shiny
---

```{css}
  tags$style(HTML("
    table.data {
      font-size: 11 px;  /* Adjust the size as needed */
    }
  ")),
  
.center-table {
  display: flex;
  justify-content: center;
  align-items: center; /* Optional: Center vertically */
}
```

```{r}
#| context: setup
#| echo: false
#| warning: false
#| message: false
#| results: 'hide'

#install.packages(TraMineR)
#install.packages("networkD3")

library(tidyverse)
library(readxl)
library(TraMineR)
library(shiny)
library(ggplot2)
library(dplyr)
library(shinydashboard)
library(dplyr)
library(tidyr)
library(plotly)

library(networkD3)


#setwd('C:/Users/Usuario/Desktop/Proyectos_Nilo/NACION/dashboard_fonid/')

df<-read_delim('respaldo_indicadores_2018_2023_con_revista.csv', delim =",")
indicadores <- read_excel('indicadores_2018_2023_con_revista.xlsx')
escuelas_primarias <- read_csv('padron_escuelas_primarias.csv') 
escuelas_primarias$cueanexo <- as.integer(escuelas_primarias$cueanexo)

df <- df %>% sample_frac(0.1)
df<-df[-1, ]
prueba<-df[,6:(65+12)]
df[,6:(65+12)][is.na(df[,6:(65+12)])] <- 0
df[,6:(65+12)][df[,6:(65+12)] > 1] <- 1
df<-df[-1, ]
colnames(df)
periodo_analisis <- seq(as.Date("2018-01-01"), as.Date("2023-12-01"), by = "month")
periodo_analisis <- format(periodo_analisis, "%b %Y")
colnames(df)[6: (65+12)] <- periodo_analisis

df <- merge(df, escuelas_primarias, by.x = "cueanexo", by.y = "cueanexo", all.x = TRUE)

docentes_total <- format(sum(indicadores$cantidad_docentes,na.rm = TRUE),scientific = FALSE)

docentes_total_titular <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Titular')%>% pull(cantidad_docentes),na.rm=TRUE),scientific = FALSE)
docentes_total_suplente <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Suplente')%>% pull(cantidad_docentes),na.rm=TRUE),scientific = FALSE)
docentes_total_interino <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Interino')%>% pull(cantidad_docentes),na.rm=TRUE),scientific = FALSE)

docentes_estables_titular <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Titular')%>% pull(estables),na.rm=TRUE),scientific = FALSE)
docentes_no_estables_titular <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Titular')%>% pull(no_estables),na.rm=TRUE),scientific = FALSE)
docentes_suplentes_titular <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Titular')%>% pull(suplentes_teoricos),na.rm=TRUE),scientific = FALSE)


docentes_estables_suplente <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Suplente')%>% pull(estables),na.rm=TRUE),scientific = FALSE)
docentes_no_estables_suplente <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Suplente')%>% pull(no_estables),na.rm=TRUE),scientific = FALSE)
docentes_suplentes_suplente <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Suplente')%>% pull(suplentes_teoricos),na.rm=TRUE),scientific = FALSE)

docentes_estables_interino <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Interino')%>% pull(estables),na.rm=TRUE),scientific = FALSE)
docentes_no_estables_interino <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Interino')%>% pull(no_estables),na.rm=TRUE),scientific = FALSE)
docentes_suplentes_interino <- format(sum(indicadores %>% filter (REVISTA_DESC == 'Interino')%>% pull(suplentes_teoricos),na.rm=TRUE),scientific = FALSE)



#porc_docentes_estables <- round(as.integer(docentes_estables)/as.integer(docentes_total),3) *100
#porc_docentes_no_estables <- round(as.integer(docentes_no_estables)/as.integer(docentes_total),3) *100
#porc_docentes_suplentes <- round(as.integer(docentes_suplentes)/as.integer(docentes_total),3) *100
#porc_total <- porc_docentes_estables + porc_docentes_no_estables + porc_docentes_suplentes

#docentes_total_mes <- format(sum(indicadores$meses_trabajados_suma,na.rm = TRUE),scientific = FALSE)
#docentes_estables_mes <- format(sum(indicadores$estables_meses,na.rm = TRUE),scientific = FALSE)
#docentes_no_estables_mes <- format(sum(indicadores$no_estables_meses,na.rm = TRUE),scientific = FALSE)
#docentes_suplentes_mes <- format(sum(indicadores$suplentes_teoricos_meses,na.rm = TRUE),scientific = FALSE)

#porc_docentes_estables_mes <- round(as.integer(docentes_estables_mes)/as.integer(docentes_total_mes),3) *100
#porc_docentes_no_estables_mes <- round(as.integer(docentes_no_estables_mes)/as.integer(docentes_total_mes),3) *100
#porc_docentes_suplentes_mes <- round(as.integer(docentes_suplentes_mes)/as.integer(docentes_total_mes),3) *100
#porc_total_mes <- porc_docentes_estables_mes + porc_docentes_no_estables_mes + porc_docentes_suplentes_mes


antiguedad <- round(mean(indicadores$antiguedad_promedio_total),2)


#sample_df <- df[sample(1:nrow(df), nrow(df)*0.05), ]

#sample_df.alphabet <- c(1,0)
#sample_df.scodes <- c("SI", "NO")
#sample_df.labels <- c("mes_trabajado","no_trabajado")

#sample_df.seq <- seqdef(sample_df, 6:65, alphabet = sample_df.alphabet, states = sample_df.scodes, 
#                   labels = sample_df.labels, xtstep = 2)

#Tipo <- c('Estables', 'No_Estables', 'Suplentes','Total')
#Cantidad <- c(docentes_estables, docentes_no_estables,docentes_suplentes,docentes_total)
#Porc <- c(porc_docentes_estables,porc_docentes_no_estables,porc_docentes_suplentes,porc_total)
#Meses <-c(docentes_estables_mes, docentes_no_estables_mes,docentes_suplentes_mes,docentes_total_mes)
#Porc_mes <-c(porc_docentes_estables_mes,porc_docentes_no_estables_mes,porc_docentes_suplentes_mes,porc_total_mes)

#resumen <- data.frame(Tipo, Cantidad,Porc,Meses,Porc_mes)

```

```{r}
#| context: setup
#| echo: false
#| warning: false
#| message: false
#| results: 'hide'


df_0<-read_delim('respaldo_indicadores_2018_2023.csv', delim =",")
indicadores_0 <- read_excel('indicadores_2018_2023.xlsx')
df_0 <- df_0 %>% sample_frac(0.1)
df_0<-df_0[-1, ]
df_0[,5:(64+12)][is.na(df_0[,5:(64+12)])] <- 0
df_0[,5:(64+12)][df_0[,5:(64+12)] > 1] <- 1
df_0<-df_0[-1, ]
colnames(df_0)[5: (64+12)] <- periodo_analisis
df_0 <- merge(df_0, escuelas_primarias, by.x = "cueanexo", by.y = "cueanexo", all.x = TRUE)




docentes_total_0 <- format(sum(indicadores_0$cantidad_docentes,na.rm = TRUE),scientific = FALSE)
docentes_estables_0 <- format(sum(indicadores_0$estables,na.rm = TRUE),scientific = FALSE)
docentes_no_estables_0 <- format(sum(indicadores_0$no_estables,na.rm = TRUE),scientific = FALSE)
docentes_suplentes_0 <- format(sum(indicadores_0$suplentes_teoricos,na.rm = TRUE),scientific = FALSE)

porc_docentes_estables_0 <- round(as.integer(docentes_estables_0)/as.integer(docentes_total_0),3) *100
porc_docentes_no_estables_0 <- round(as.integer(docentes_no_estables_0)/as.integer(docentes_total_0),3) *100
porc_docentes_suplentes_0 <- round(as.integer(docentes_suplentes_0)/as.integer(docentes_total_0),3) *100
porc_total_0 <- porc_docentes_estables_0 + porc_docentes_no_estables_0 + porc_docentes_suplentes_0

docentes_total_mes_0 <- format(sum(indicadores_0$meses_trabajados_suma,na.rm = TRUE),scientific = FALSE)
docentes_estables_mes_0 <- format(sum(indicadores_0$estables_meses,na.rm = TRUE),scientific = FALSE)
docentes_no_estables_mes_0 <- format(sum(indicadores_0$no_estables_meses,na.rm = TRUE),scientific = FALSE)
docentes_suplentes_mes_0 <- format(sum(indicadores_0$suplentes_teoricos_meses,na.rm = TRUE),scientific = FALSE)

porc_docentes_estables_mes_0 <- round(as.integer(docentes_estables_mes_0)/as.integer(docentes_total_mes_0),3) *100
porc_docentes_no_estables_mes_0 <- round(as.integer(docentes_no_estables_mes_0)/as.integer(docentes_total_mes_0),3) *100
porc_docentes_suplentes_mes_0 <- round(as.integer(docentes_suplentes_mes_0)/as.integer(docentes_total_mes_0),3) *100
porc_total_mes_0 <- porc_docentes_estables_mes_0 + porc_docentes_no_estables_mes_0 + porc_docentes_suplentes_mes_0

antiguedad_0 <- round(mean(indicadores_0$antiguedad_promedio_total),2)

sample_df_0 <- df_0[sample(1:nrow(df_0), nrow(df_0)*0.1), ]

sample_df_0.alphabet <- c(1,0)
sample_df_0.scodes <- c("SI", "NO")
sample_df_0.labels <- c("mes_trabajado","no_trabajado")

sample_df_0.seq <- seqdef(sample_df_0, 5:(64+12), alphabet = sample_df_0.alphabet, states = sample_df_0.scodes, 
                   labels = sample_df_0.labels, xtstep = 2)

Tipo <- c('Estables', 'No_Estables', 'Temporales','Total')
Cantidad <- c(docentes_estables_0, docentes_no_estables_0,docentes_suplentes_0,docentes_total_0)
Porc <- c(porc_docentes_estables_0,porc_docentes_no_estables_0,porc_docentes_suplentes_0,porc_total_0)
Meses <-c(docentes_estables_mes_0, docentes_no_estables_mes_0,docentes_suplentes_mes_0,docentes_total_mes_0)
Porc_mes <-c(porc_docentes_estables_mes_0,porc_docentes_no_estables_mes_0,porc_docentes_suplentes_mes_0,porc_total_mes_0)

resumen_0 <- data.frame(Tipo, Cantidad,Porc,Meses,Porc_mes)


```

```{r}
#| context: setup
#| echo: false
#| warning: false
#| message: false
#| results: 'hide'

df_x<-read_delim('evol_2018_2023_con_revista.csv', delim =",")

df_x <- merge(df_x, escuelas_primarias, by.x = "cueanexo", by.y = "cueanexo", all.x = TRUE)

df_x <- df_x %>% sample_frac(0.1)

#df_x[,4:(63+12)][df_x[,4:(63+12)] == 4] <- 1
#df_x[,4:63+12][df_x[,4:(63+12)] == 6] <- 1
#df_x[,4:63+12][df_x[,4:(63+12)] == 8] <- 5
#df_x[,4:63+12][df_x[,4:(63+12)] == 9] <- 1

colnames(df_x)[4: (63+12)] <- periodo_analisis

df_x.alphabet <- c(1,3,5,0)
df_x.scodes <- c("Titular","Suplente","Interino","no_trabajado")
df_x.labels <- c("Titular","Suplente","Interino","no_trabajado")

df_x.seq <- seqdef(df_x, 4:(63+12), alphabet = df_x.alphabet, states = df_x.scodes, 
                   labels = df_x.labels, xtstep = 4)


df_temp<-read_delim('respaldo_indicadores_2018_2023.csv', delim =",")

df_xx_tipo<-merge(df_x,df_temp[,c('cueanexo','CUIL','meses_trabajados')], by =c('cueanexo','CUIL'), all.x = TRUE)

df_x_tipo <- df_xx_tipo %>% sample_frac(0.1)

rm(df_temp)

```

```{r}
#| context: setup
#| echo: false
#| warning: false
#| message: false
#| results: 'hide'

library(plotly)

evol_x_mes<-read_delim('evolucion_resumen_solo_activos_por_mes_2018_2023.csv', delim =",")
evol_total <- evol_x_mes %>% filter (provincia == 'Todos')
evol_total <- evol_total[,3:7]
evol_total$fecha <- as.Date(evol_total$fecha, format="%d-%m-%Y" )
colnames(evol_total) <- c("Titular", "Suplente","Interino","provincia","fecha")

data_long <- evol_total %>%
  tidyr::pivot_longer(cols = "Titular":"Interino", names_to = "Tipo", values_to = "value") %>%
  mutate(column = factor(Tipo, levels = c("Interino", "Suplente", "Titular")))

 grafico_barras <- ggplot(data_long, aes(x = fecha, y = value, fill = Tipo)) +
  geom_bar(stat = "identity") +
  labs(x = "Fecha", y = "Value", fill = "Columns") +
  ggtitle("Maestro de Grado por mes - Nivel Nacional") +
  scale_fill_manual(values = c("Titular" = "#7FC97F", "Suplente" = "#FDC086", "Interino" = "#FFFF99"),
                    labels =  c("Titular" = "Titular", "Suplente" = "Suplente", "Interino" = "Interino")) +
  theme_minimal() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
 
grafico_barras_interactivo <- ggplotly(grafico_barras) 
 
promedio_titulares  <- format (mean(evol_total$Titular, na.rm = TRUE), scientific = FALSE)
promedio_suplentes  <- format(mean(evol_total$Suplente, na.rm = TRUE), scientific = FALSE)
promedio_interinos  <- format(mean(evol_total$Interino, na.rm = TRUE), scientific = FALSE)

promedio_total <- format((as.numeric(promedio_titulares) + as.numeric(promedio_suplentes) +  as.numeric(promedio_interinos)), scientific =FALSE)



evol_total_provincias <- evol_x_mes %>% filter (provincia != 'Todos')
evol_total_provincias <- evol_total_provincias[,3:7]
evol_total_provincias$fecha <- as.Date(evol_total_provincias$fecha, format="%d-%m-%Y" )
colnames(evol_total_provincias) <- c("Titular", "Suplente","Interino","provincia","fecha")


data_long_provincias <- evol_total_provincias %>%
  tidyr::pivot_longer(cols = "Titular":"Interino", names_to = "Tipo", values_to = "value") %>%
  mutate(column = factor(Tipo, levels = c("Interino", "Suplente", "Titular")))

```

```{r}
#| context: setup
#| echo: false
#| warning: false
#| message: false
#| results: 'hide'


rotacion<-read_delim('evolucion_estado_dic_22_vs_todo_23.csv', delim =",")

rotacion.alphabet <- c('sin cambio','otro (cambio o dejo la escuela)','abandono sistema','cambio_puesto','ascenso (dire_vice)')
rotacion.scodes <- c("Titular","Cambio de escuela","Abandono el sistema","Cambio de puesto", "Ascenso")
rotacion.labels <- c("Titular","cambio de escuela","Abandono el sistema","Cambio de puesto", "Ascenso")


rotacion.seq <- seqdef(rotacion, 74:85, alphabet =rotacion.alphabet , states = rotacion.scodes, 
                   labels = rotacion.labels, xtstep = 5)


nodos <- data.frame(name = c ("Maestro de Grado (Titular) en Escuela X","Cambia de Puesto en la Escuela X","Asciende a directivo en la Escuela X","Abandona Sist. Educativo","Deja la Escuela X por otra","Mantiene su posicion en la Escuela X"))

links <- data.frame(
  partida = rep(0, 5),
  objetivo =c(1, 2, 3, 4, 5),
  valores = c(sum(rotacion$estado_final12 == "cambio_puesto")
              ,sum(rotacion$estado_final12 == "ascenso (dire_vice)")
              ,sum(rotacion$estado_final12 == "abandono sistema"),
              sum(rotacion$estado_final12 == "otro (cambio o dejo la escuela)")
              ,sum(rotacion$estado_final12 == "sin cambio")) 
)

total <- sum(links$valores)



# Calculate average age by final state
antigueda_prom_estado <- rotacion %>%
  group_by(estado_final12) %>%
  summarize(avg_ant = mean(ANTIG))

# Map state names to numerical codes
mappeado <- c(`abandono sistema` = 3, `ascenso (dire_vice)` = 2, `cambio_puesto` = 1, `otro (cambio o dejo la escuela)` = 4, `sin cambio` = 5)
antigueda_prom_estado$estado_final12 <- mappeado[antigueda_prom_estado$estado_final12]

# Merge the average age with the links data frame
links <- links %>%
  left_join(antigueda_prom_estado, by = c('objetivo' = 'estado_final12'))

# Add tooltip with average age
links$tooltip <- paste("Ant Promedio:", round(links$avg_ant, 2))



nodos$name <- c(
  "Maestro de Grado (Titular) en Escuela X",
  paste("Cambia de Puesto en la Escuela X (", round(100 * sum(rotacion$estado_final12 == "cambio_puesto") / total, 1), "%) - ", links[links$objetivo == 1, "tooltip"] , sep = ""),
  paste("Asciende a directivo en la Escuela X (", round(100 * sum(rotacion$estado_final12 == "ascenso (dire_vice)") / total, 1), "%) - ",links[links$objetivo == 2, "tooltip"], sep = ""),
  paste("Abandona Sist. Educativo (", round(100 * sum(rotacion$estado_final12 == "abandono sistema") / total, 1), "%) - " ,links[links$objetivo == 3, "tooltip"], sep = ""),
  paste("Deja la Escuela X por otra (", round(100 * sum(rotacion$estado_final12 == "otro (cambio o dejo la escuela)") / total, 1), "%) - ",links[links$objetivo == 4, "tooltip"], sep = ""),
  paste("Mantiene su posicion en la Escuela X (", round(100 * sum(rotacion$estado_final12 == "sin cambio") / total, 1), "%) - ",links[links$objetivo == 5, "tooltip"], sep = "")
)


```

# Gráfico de secuencia - Indicadores - Nivel Nacional

## Row {height = "60 px"}

### Column {width="50%"}

```{r}


cpal(sample_df_0.seq)<-c("#C87850","white")

seqIplot(sample_df_0.seq, sortv = "from.start", with.legend = "right", 
             main = paste("Sec Nacional"), cex.legend = 0.7)
invisible()
```

### Column {width="50%"}

```{r}
df_x.seq_mitad <- df_x.seq %>% sample_frac(0.1)

cpal(df_x.seq_mitad)<-c("#7FC97F" ,"#FDC086","#FFFF99","white")

seqIplot(df_x.seq_mitad, sortv = "from.start", with.legend = "right", 
             main = paste("Sec Nacional"), cex.legend = 0.7)
invisible()

```

## Row {height = "60px"}

### Column {width="50%"}

```{r}
knitr::kable(resumen_0, align = "c")
```

### Column {width="50%"}

En el periodo de análisis que es de 72 meses, se usaron `{r} docentes_total_0` docentes, en este periodo la continuidad de los docentes en una escuela es de `{r} antiguedad_0` meses en promedio . En el gráfico de la izquierda se muestra la continuidad de los docentes independientemente de su situaciC3n de revista, en el gráfico de la derecha se muestra esa continuidad desagregada por situaciC3n de revista

Adicionalmente los docente fueron tipificados, según su continuidad en las escuelas.

`{r} strong("Docentes Estables")` : `{r} docentes_estables_0` son docentes estables, es decir, que han trabajado en una escuela durante el 80% o más del periodo de análisis. Esto representa el `{r} porc_docentes_estables_0`% del total. Se puede observar en el gráfico de la derecha que estos están compuestos principalmente por docentes titulares y se evidencia en la gruesa mancha verde que atraviesa el gráfico, en tanto los suplentes (naranja) y los interinos (amarillos) aportan en menor medida.

`{r} strong("Docentes No Estabales")` : `{r} docentes_no_estables_0` son docentes que han trabajado en una escuela entre el 80% y 4 meses del periodo de análisis. Esto representa el `{r} porc_docentes_no_estables_0`% del total.

`{r} strong("Temporales")`: `{r} docentes_suplentes_0` son docentes que han estado en la escuela por periodos muy cortos, entre 3 y 1 mes. Esto representa el `{r} porc_docentes_suplentes_0`% del total. Si bien representa una cantidad importante de docentes su estadía en las escuelas es muy corta, se puede ver en lo vacíos con puntos intermitentes.

El comportamiento que se describe resume la situación nacional, sin embargo esto puede cambiar dependiendo de la provincia que se analice.

## Row {height= "5px"}

Para mayor claridad se hace una desagregación de los gráficos superiores de modo que se evidencie la tipificación según su continuidad.

## Row {height = "20px"}

### Column {width="50%"}

```{r}
sample_df_0_estables <-  sample_df_0%>% filter(meses_trabajados > (60+12)*0.8)
sample_df_0_estables.seq <- seqdef(sample_df_0_estables, 5:(64+12), alphabet = sample_df_0.alphabet, states = sample_df_0.scodes, 
                   labels = sample_df_0.labels, xtstep = 2)

cpal(sample_df_0_estables.seq)<-c("#C87850","white")
seqIplot(sample_df_0_estables.seq , sortv = "from.start", with.legend = "right",main = paste("Sec Nacional - Estables"), cex.legend = 0.7)
invisible()
```

### Column {width="50%"}

```{r}
#setwd('C:/Users/Usuario/Desktop/Proyectos_Nilo/NACION/dashboard_fonid')

#df_temp<-read_delim('respaldo_indicadores_2019_2023.csv', delim =";")

#df_x_tipo<-merge(df_x,df_temp[,c('cueanexo','CUIL','meses_trabajados')], by =c('cueanexo','CUIL'), all.x = TRUE)

#df_x_tipo <- df_x_tipo %>% sample_frac(0.1)

df_x_tipo_estables <-  df_x_tipo%>% filter(meses_trabajados > (60+12)*0.8)
df_x_tipo_estables.seq <- seqdef(df_x_tipo_estables, 4:(63+12), alphabet = df_x.alphabet, states = df_x.scodes, 
                   labels = df_x.labels, xtstep = 2)

cpal(df_x_tipo_estables.seq)<-c("#7FC97F" ,"#FDC086","#FFFF99","white")

seqIplot(df_x_tipo_estables.seq , sortv = "from.start", with.legend = "right",main = paste("Sec Nacional - Estables"), cex.legend = 0.7)
invisible()
rm(df_temp)
```

## Row {height = "20px"}

### Column {width="50%"}

```{r}
sample_df_0_estables <-  sample_df_0%>% filter(meses_trabajados < (60+12)*0.8 & meses_trabajados > 3)
sample_df_0_estables.seq <- seqdef(sample_df_0_estables, 5:(64+12), alphabet = sample_df_0.alphabet, states = sample_df_0.scodes, 
                   labels = sample_df_0.labels, xtstep = 2)

cpal(sample_df_0_estables.seq)<-c("#C87850","white")
seqIplot(sample_df_0_estables.seq , sortv = "from.start", with.legend = "right",main = paste("Sec Nacional - No Estables"), cex.legend = 0.7)
invisible()
```

### Column {width="50%"}

```{r}
#setwd('C:/Users/Usuario/Desktop/Proyectos_Nilo/NACION/dashboard_fonid')

df_x_tipo_estables <-  df_x_tipo%>% filter(meses_trabajados < (60+12)*0.8 & meses_trabajados > 3 )
df_x_tipo_estables.seq <- seqdef(df_x_tipo_estables, 4:(63+12), alphabet = df_x.alphabet, states = df_x.scodes, 
                   labels = df_x.labels, xtstep = 2)

cpal(df_x_tipo_estables.seq)<-c("#7FC97F" ,"#FDC086","#FFFF99","white")

seqIplot(df_x_tipo_estables.seq , sortv = "from.start", with.legend = "right",main = paste("Sec Nacional - No Estables"), cex.legend = 0.7)
invisible()

```

## Row {height = "20px"}

### Column {width="50%"}

```{r}
sample_df_0_estables <-  sample_df_0%>% filter(meses_trabajados <= 3)
sample_df_0_estables.seq <- seqdef(sample_df_0_estables, 5:(64+12), alphabet = sample_df_0.alphabet, states = sample_df_0.scodes, 
                   labels = sample_df_0.labels, xtstep = 2)

cpal(sample_df_0_estables.seq)<-c("#C87850","white")
seqIplot(sample_df_0_estables.seq , sortv = "from.start", with.legend = "right",main = paste("Sec Nacional - Temporales"), cex.legend = 0.7)
invisible()
```

### Column {width="50%"}

```{r}
#setwd('C:/Users/Usuario/Desktop/Proyectos_Nilo/NACION/dashboard_fonid')

df_x_tipo_estables <-  df_x_tipo%>% filter( meses_trabajados <= 3 )
df_x_tipo_estables.seq <- seqdef(df_x_tipo_estables, 4:(63+12), alphabet = df_x.alphabet, states = df_x.scodes, 
                   labels = df_x.labels, xtstep = 2)

cpal(df_x_tipo_estables.seq)<-c("#7FC97F" ,"#FDC086","#FFFF99","white")

seqIplot(df_x_tipo_estables.seq , sortv = "from.start", with.legend = "right",main = paste("Sec Nacional - Temporales"), cex.legend = 0.7)
invisible()

```

# Gráfico de secuencia - Nivel Provincial

##  {.sidebar}

```{r}
selectInput("provincia_0", "Seleccionar provincia", 
            choices=unique(df_0$provincia),selected="Catamarca")

radioButtons("sector_0", "Seleccionar sector", 
             choices = c("All", unique(df_0$sector)), 
             selected = "All")
```

## Row

### Column {width="45%"}

```{r}
plotOutput("seqPlot_0")
```

### Column {width="45%"}

```{r}
tableOutput("df_provincia_indicadores_0")
```

## Row

### Column {width="45%"}

```{r}

plotOutput("seqPlot_x")
```

### Column {width="45%"}

```{r}
textOutput("antiguedad_provincia_0")
```

# Evolución de la planta de Maestros de Grado

##  {.sidebar}

```{r}
selectInput("provincia_barras", "Seleccionar provincia", 
            choices=unique(data_long_provincias$provincia),selected="Catamarca")
```

## Column {width="60%"}

```{r}
plotlyOutput("grafico_barras_interactivo_provincia")
```

```{r}
grafico_barras_interactivo 
```

## Column {width="30%"}

```{r}

box(
valueBoxOutput('interino_provincia'),
valueBoxOutput('suplente_provincia'),
valueBoxOutput('titular_provincia'),
valueBoxOutput('Total_provincia')
)

box(
valueBox(round(as.numeric(promedio_interinos),0), 'Cantidad Promedio Interinos'),
valueBox(round(as.numeric(promedio_suplentes),0), 'Cantidad Promedio Suplentes'),
valueBox(round(as.numeric(promedio_titulares),0), 'Cantidad Promedio Titulares'),
valueBox(round(as.numeric(promedio_total),0),'Cantidad Promedio Total')
)
```

# Gráfico de secuencia - Nivel Provincial (Sit_Revista)

## Row

###  {.sidebar}

```{r}
selectInput("provincia", "Seleccionar provincia", 
            choices=unique(df$provincia),selected="Catamarca")

radioButtons("sector", "Seleccionar sector", 
             choices = c("All", unique(df$sector)), 
             selected = "All")

radioButtons("revista", "Seleccionar sit. Revista", 
             choices = c("All", unique(df$REVISTA_DESC)), 
             selected = "All")

```

### Column {width="52%"}

```{r}
plotOutput("seqPlot")
```

### Column {width="48%"}

```{r}
tableOutput("df_provincia_indicadores")
```

En esta sección de gráficos, cada línea de datos representa una combinación única de CUE, CUIL y SIT REVISTA. Esto significa que, si un docente tiene múltiples cargos en la misma escuela (por ejemplo, uno titular y otro suplente), se cuenta como una sola.

Esta diferencia en la forma de contar hace que los totales no coincidan con los gráficos anteriores, donde cada combinación de CUE y CUIL era tratada de manera individual. Sin embargo, esta estructura es útil para analizar cuál es el tipo de situación de revista (como titular, suplente o interino) que predomina entre los distintos tipos de docentes: estables, no estables y temporales.

# Rotación de Docentes Titulares

## Row

### Column {width = 45%}

```{r}
seqdplot(rotacion.seq , sortv = "from.start", with.legend = FALSE ,main = paste("EvoluciC3n Maestros Titulares dic/22-23"), cex.legend = 0.7)
invisible()

cpal(rotacion.seq)<-c("#7FC97F", "#BEAED4" ,"#FDC086", "#FFFF99","#386CB0" )

```

### Column {width = 55%}

```{r}
#install.packages("networkD3")
library(networkD3)
library(htmlwidgets)


node_colors <- 'd3.scaleOrdinal(["#4CAF50","#386CB0","#FFFF99","#FDC086","#BEAED4","#7FC97F"])'

sankey <- sankeyNetwork(
  Links = links,
  Nodes = nodos,
  Source = "partida",
  Target = "objetivo",
  Value = "valores",
  NodeID = "name",
  units = "",
  fontSize = 12,
  nodeWidth = 40,
  colourScale = node_colors
)
# Add a title to the Sankey diagram
sankey_with_title <- htmlwidgets::prependContent(
  sankey,
  htmltools::tags$h5(
    "Estado Maestro Titular Dic 22 vs Dic 23",
    style = "font-weight: bold; text-align: center; font-size: 11px;"
  )
)

# Display the Sankey diagram with tooltips and title

sankey_with_title

```

## Row

En esta sección, se analiza la rotación de los maestros de grado titulares al finalizar el año 2022. Se busca visualizar su situación en el siguiente año y clasificar los posibles escenarios:

-   Continúan en la misma escuela en la que trabajaban.
-   Abandonan el sistema educativo.
-   Cambian de puesto en la misma escuela
-   Dejan la escuela, pero se mantienen en el sistema.
-   Ascienden a un puesto directivo.

# Rotación de Docentes Titulares - Nivel Provincial

## Row

### Column {width="15%"}

####  {.sidebar}

```{r}
selectInput("provincia_rotacion", "Seleccionar provincia", 
            choices=unique(rotacion$provincia),selected="Catamarca")

radioButtons("sector_rotacion", "Seleccionar sector", 
             choices = c("All", unique(rotacion$sector)), 
             selected = "All")
```

### Column {width="42%"}

```{r}
plotOutput("seqPlot_rotacion")
```

### Column {width="42%"}

```{r}

sankeyNetworkOutput("sankey_rotacion_provincia")
```

# Cantidad de Maestros de Grado (cuiles) 2018-2023

```{r}
#setwd('C:/Users/Usuario/Desktop/Proyectos_Nilo/NACION/dashboard_fonid')
evol_cuiles <-read_delim('cantidad_cuiles_maestros.csv', delim =",")

evol_cuiles$fecha <- as.Date(paste("01", evol_cuiles$fecha, sep = "/"), format = "%d/%m/%Y")

fig_evolucion_cuil <-plot_ly(data=evol_cuiles,x=~fecha,y =~num_personas, type = 'scatter',mode='lines', line = list(color = 'blue', width = 2)) %>%
  layout(title = 'Cuiles por mes - Maestro de Grado',
         yaxis  = list(title = 'Cantidad',range = c(150000, 250000)),
         xaxis = list(title = 'Fecha'))

fig_evolucion_cuil

```


#  Secuencia - CUILES

##  Row

```{r}

secuencia_cuiles <-read_delim('secuencia_cuiles_maestros.csv', delim =",")

secuencia_cuiles <- sample_frac(secuencia_cuiles, size = 0.1)

colnames(secuencia_cuiles)[3: (4+72)] <- periodo_analisis

secuencia_cuiles.alphabet <- c(1,0)
secuencia_cuiles.scodes <- c("SI", "NO")
secuencia_cuiles.labels <- c("mes_trabajado","no_trabajado")

secuencia_cuiles.seq <- seqdef(secuencia_cuiles, 3:(2+72), alphabet = secuencia_cuiles.alphabet, states = secuencia_cuiles.scodes, 
                   labels = secuencia_cuiles.labels, xtstep = 2)


cpal(secuencia_cuiles.seq)<-c("#7FC97F" ,"white")

seqIplot(secuencia_cuiles.seq, sortv = "from.start", with.legend = "right", 
             main = paste("Sec Nacional"), cex.legend = 0.7)
invisible()


```



```{r}

secuencia_cuiles_clasificados <-read_delim('secuencia_cuiles_maestros_clasificados.csv', delim =",")

secuencia_cuiles_clasificados <- sample_frac(secuencia_cuiles_clasificados, size = 0.1)

colnames(secuencia_cuiles_clasificados)[3: (4+72)] <- periodo_analisis

secuencia_cuiles_clasificados.alphabet <- c(1,2,5,4,3,0)
secuencia_cuiles_clasificados.scodes <- c("Permanete","Salida","Intermitente","Corto_Continuo","Ingreso","No_Trabajado")
secuencia_cuiles_clasificados.labels <- c("Permanete","Salida","Intermitente","Corto_Continuo","Ingreso","No_Trabajado")

secuencia_cuiles_clasificados.seq <- seqdef(secuencia_cuiles_clasificados, 3:(2+72), alphabet = secuencia_cuiles_clasificados.alphabet, states = secuencia_cuiles_clasificados.scodes, 
                   labels = secuencia_cuiles_clasificados.labels, xtstep = 6)

cpal(secuencia_cuiles_clasificados.seq)<-c("#7FC97F",'blue','orange','red','black',"white")
seqIplot(secuencia_cuiles_clasificados.seq, sortv = "from.start", with.legend = "right", 
             main = paste("Sec Nacional_clasificados"), cex.legend = 0.7)
invisible()

```
##  Row

```{r}

clasificacion_total <-read_delim('clasificacion_total.csv', delim =",")

primer_ultimo_valor_ant <- read_delim('valores(primer_ultimo)_antiguedad.csv',delim=",")

primer_ultimo_valor_ant <- primer_ultimo_valor_ant[, 2:ncol(primer_ultimo_valor_ant)]

primer_ultimo_valor_ant$primer_valor_antiguedad <- round(primer_ultimo_valor_ant$primer_valor_antiguedad,1)

primer_ultimo_valor_ant$ultimo_valor_antiguedad <- round(primer_ultimo_valor_ant$ultimo_valor_antiguedad,1)


clasificacion_total  <- left_join(clasificacion_total , primer_ultimo_valor_ant, by = "classification")


knitr::kable(clasificacion_total, align = "c",caption = "Clasificacion - Nivel Nacional")

```

```{r}

caso_gcaba <-read_delim('caso_gcaba.csv', delim =",")
knitr::kable(caso_gcaba, align = "c",caption = "Clasificacion - GCABA - edad")

```


# Rotacion CUILES entre escuelas


```{r}
setwd('C:/Users/Usuario/Desktop/Proyectos_Nilo/NACION/dashboard_fonid')

cuiles_entre_cues <-read_delim('cuiles_historico_cues.csv', delim =";")

cuiles_entre_cues <- sample_frac(
cuiles_entre_cues, size = 0.1)

cuiles_entre_cues <- cuiles_entre_cues %>%
  mutate(across(where(is.numeric), ~ ifelse(. > 3, 4, .)))

colnames(cuiles_entre_cues)[4: (3+72)] <- periodo_analisis

#

cuiles_entre_cues.alphabet <- c(1,0,-1,2,3,4)
cuiles_entre_cues.scodes <- c("1era_escuela","sin_escuela", "dos_escuelas","2da_escuela","3era_escuela","4ta_escuela_a_mas")
cuiles_entre_cues.labels <- c("1era_escuela","sin_escuela", "dos_escuelas","2da_escuela","3era_escuela","4ta_escuela_a_mas")

cuiles_entre_cues.seq <- seqdef(cuiles_entre_cues, 4: (3+72), alphabet = cuiles_entre_cues.alphabet, states = cuiles_entre_cues.scodes, 
                   labels = cuiles_entre_cues.labels, xtstep = 6)


#cpal(cuiles_entre_cues.seq) <- c( "#8FD494" , "#e41a1c", "#377EB8", "#FFD92F", "#4B0082", "#D147A3")

#cpal(cuiles_entre_cues.seq)<-c("white","lightblue","blue","red","green","black")

seqIplot(cuiles_entre_cues.seq, sortv = "from.start", with.legend = "right", 
             main = paste("Sec Nacional"), cex.legend = 0.7)

invisible()

```


```{r}
cuiles_entre_cues <-read_delim('cuiles_historico_cues.csv', delim =";")

cuiles_entre_cues <- sample_frac(
cuiles_entre_cues, size = 0.1)

cuiles_entre_cues <- cuiles_entre_cues %>%
  mutate(across(where(is.numeric), ~ ifelse(. > 3, 4, .)))

colnames(cuiles_entre_cues)[4: (3+72)] <- periodo_analisis

cuiles_entre_cues.alphabet <- c(1,0,-1,2,3,4)
cuiles_entre_cues.scodes <- c("1era_escuela","sin_escuela", "dos_escuelas","2da_escuela","3era_escuela","4ta_escuela_a_mas")
cuiles_entre_cues.labels <- c("1era_escuela","sin_escuela", "dos_escuelas","2da_escuela","3era_escuela","4ta_escuela_a_mas")

cuiles_entre_cues.seq <- seqdef(cuiles_entre_cues, 4:(3+72), alphabet = cuiles_entre_cues.alphabet, states = cuiles_entre_cues.scodes, 
                   labels = cuiles_entre_cues.labels, xtstep = 6)


#cpal(cuiles_entre_cues.seq)<-c("lightblue","blue","red","green","black","white")

seqIplot(cuiles_entre_cues.seq, group=cuiles_entre_cues$EDAD ,sortv = "from.start", with.legend = "right", 
             main = paste("Sec Nacional"), cex.legend = 0.7)
invisible()

```



```{r}
#| context: server

####

indicadores_filtrados_0 <- reactive(
{
if (input$sector_0 == "All") {
    # If "All" is selected, filter only by provincia
    indicadores_0 %>% filter(provincia == input$provincia_0)
  } else {
    # Otherwise, filter by both provincia and ambito
    indicadores_0 %>% filter(provincia == input$provincia_0 & sector == input$sector_0)
  }
})

reactive_indicadores_0 <- reactive({ indicadores_filtrados_0()})

output$df_provincia_indicadores_0 <- renderTable({
  data_indicadores_0 <- reactive_indicadores_0()
  
  # Create a dataframe with the required values
  data.frame(
    Tipo = c('Estables', 'No_Estables','Temporales','Total'),
    Cantidad = c(
      format(sum(data_indicadores_0$estables, na.rm = TRUE),scientific = FALSE),  
      format(sum(data_indicadores_0$no_estables, na.rm = TRUE),scientific = FALSE),
      format(sum(data_indicadores_0$suplentes_teoricos, na.rm = TRUE),scientific = FALSE),
      format(sum(data_indicadores_0$cantidad_docentes, na.rm = TRUE),scientific = FALSE)
    ),
    Porc = c(
      round((sum(data_indicadores_0$estables, na.rm = TRUE)/sum(data_indicadores_0$cantidad_docentes, na.rm = TRUE)),3)*100,
      round((sum(data_indicadores_0$no_estables, na.rm = TRUE)/sum(data_indicadores_0$cantidad_docentes, na.rm = TRUE)),3)*100,
      round((sum(data_indicadores_0$suplentes_teoricos, na.rm = TRUE)/sum(data_indicadores_0$cantidad_docentes, na.rm = TRUE)),3)*100,
      round((sum(data_indicadores_0$cantidad_docentes, na.rm = TRUE)/sum(data_indicadores_0$cantidad_docentes, na.rm = TRUE)),3)*100),
    Meses = c(
      format(sum(data_indicadores_0$estables_meses, na.rm = TRUE),scientific = FALSE),  
      format(sum(data_indicadores_0$no_estables_meses, na.rm = TRUE),scientific = FALSE),
      format(sum(data_indicadores_0$suplentes_teoricos_meses, na.rm = TRUE),scientific = FALSE),
      format(sum(data_indicadores_0$meses_trabajados_suma, na.rm = TRUE),scientific = FALSE)
    ),
    Porc_meses = c(
      round((sum(data_indicadores_0$estables_meses, na.rm = TRUE)/sum(data_indicadores_0$meses_trabajados_suma, na.rm = TRUE)),3)*100,
      round((sum(data_indicadores_0$no_estables_meses, na.rm = TRUE)/sum(data_indicadores_0$meses_trabajados_suma, na.rm = TRUE)),3)*100,
      round((sum(data_indicadores_0$suplentes_teoricos_meses, na.rm = TRUE)/sum(data_indicadores_0$meses_trabajados_suma, na.rm = TRUE)),3)*100,
      round((sum(data_indicadores_0$meses_trabajados_suma, na.rm = TRUE)/sum(data_indicadores_0$meses_trabajados_suma, na.rm = TRUE)),3)*100)
    )
})


output$antiguedad_provincia_0 <- renderText({
  data_indicadores_0 <- reactive_indicadores_0()
  ant_0 <- round(sum(data_indicadores_0$meses_trabajados_suma)/sum(data_indicadores_0$cantidad_docentes),2)
  dif <- ant_0 - antiguedad_0
  paste ("En la provincia de ",input$provincia_0,". La continuidad promedio docente es de :", ant_0, '. En tanto la continuidad a nivel nacional es de: ', antiguedad_0, '. La diferencia es de ', dif , 'si C)sta es positiva, denotarC-a un continuidad mayor de sus docentes con respecto al promedio nacional y si es negativa serC-a lo contrario.')  
  })



###

filtered_data_0 <-reactive({
if (input$sector_0 == "All") {
    # If "All" is selected, filter only by provincia
    df_0 %>% filter(provincia == input$provincia_0)
  } else {
    # Otherwise, filter by both provincia and ambito
    df_0 %>% filter(provincia == input$provincia_0 & sector == input$sector_0)
  }
})

reactive_seq_0 <- reactive({
  data_0 <- filtered_data_0()
  secuencia_prov_0 <- seqdef(data_0,5:(64+12),alphabet = c(1,0),states = c("SI","NO"),
                                                labels = c("mes_trabajado", "no_trabajado"), xtstep = 2)
  cpal(secuencia_prov_0)<-c("#C87850","white")
  return (secuencia_prov_0)
                          })

output$seqPlot_0 <- renderPlot({
    

    seqIplot(reactive_seq_0(), sortv = "from.start", with.legend = "right", 
             main = paste("Secuencia -", input$provincia_0), cex.legend = 0.7)
      })


#####################################################################################################


indicadores_filtrados <- reactive({
  # Handle filtering for both 'sector' and 'SIT_rEVISTA'
  if (input$sector == "All" & input$revista == "All") {
    # If both 'sector' and 'SIT_rEVISTA' are set to "All", filter only by 'provincia'
    indicadores %>% filter(provincia == input$provincia)
  } else if (input$sector == "All") {
    # If only 'sector' is "All", filter by 'provincia' and 'SIT_rEVISTA'
    indicadores %>% filter(provincia == input$provincia & REVISTA_DESC == input$revista)
  } else if (input$revista == "All") {
    # If only 'SIT_rEVISTA' is "All", filter by 'provincia' and 'sector'
    indicadores %>% filter(provincia == input$provincia & sector == input$sector)
  } else {
    # Otherwise, filter by all three criteria: 'provincia', 'sector', and 'SIT_rEVISTA'
    indicadores %>% filter(provincia == input$provincia & 
                           sector == input$sector & 
                           REVISTA_DESC == input$revista)
  }
})


reactive_indicadores <- reactive({ indicadores_filtrados()})

output$df_provincia_indicadores <- renderTable({
  data_indicadores <- reactive_indicadores()
  
  # Create a dataframe with the required values
  data.frame(
    Tipo = c ('Estables','Estables','Estables','Estables','No_Estables','No_Estables','No_Estables','No_Estables','Temporales','Temporales','Temporales','Temporales','Total'),
    Sit_revista = c('Titulares','Suplente','Interino','Sub_total','Titulares','Suplente','Interino','Sub_total','Titulares','Suplente','Interino','Sub_total','Total'),
    Cantidad = c(
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Titular')%>% pull(estables),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Suplente')%>% pull(estables),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Interino')%>% pull(estables),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores%>% pull(estables),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Titular')%>% pull(no_estables),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Suplente')%>% pull(no_estables),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Interino')%>% pull(no_estables),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores%>% pull(no_estables),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Titular')%>% pull(suplentes_teoricos),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Suplente')%>% pull(suplentes_teoricos),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores %>% filter (REVISTA_DESC == 'Interino')%>% pull(suplentes_teoricos),na.rm=TRUE),scientific = FALSE),
      format(sum(data_indicadores%>% pull(suplentes_teoricos),na.rm=TRUE),scientific = FALSE),
      
      format(sum(data_indicadores$cantidad_docentes,na.rm = TRUE),scientific = FALSE)
    ))
})


filtered_data <-reactive({
  # Handle filtering for both 'sector' and 'SIT_rEVISTA'
  if (input$sector == "All" & input$revista == "All") {
    # If both 'sector' and 'SIT_rEVISTA' are set to "All", filter only by 'provincia'
    df %>% filter(provincia == input$provincia)
  } else if (input$sector == "All") {
    # If only 'sector' is "All", filter by 'provincia' and 'SIT_rEVISTA'
    df %>% filter(provincia == input$provincia & REVISTA_DESC == input$revista)
  } else if (input$revista == "All") {
    # If only 'SIT_rEVISTA' is "All", filter by 'provincia' and 'sector'
    df %>% filter(provincia == input$provincia & sector == input$sector)
  } else {
    # Otherwise, filter by all three criteria: 'provincia', 'sector', and 'SIT_rEVISTA'
    df %>% filter(provincia == input$provincia & 
                           sector == input$sector & 
                           REVISTA_DESC == input$revista)
  }
})


reactive_seq <- reactive({
  data <- filtered_data()
  secuencia_prov <- seqdef(data,6:(65+12),alphabet = c(1,0),states = c("SI","NO"),
                                                   labels = c("mes_trabajado", "no_trabajado"), xtstep = 2)
  
  return (secuencia_prov)
                          })

output$seqPlot <- renderPlot({
    seqIplot(reactive_seq(), sortv = "from.start", with.legend = "right", 
             main = paste("Secuencia -", input$provincia), cex.legend = 0.7)
  })


################################################################################


filtered_data_x <-reactive({
if (input$sector_0 == "All") {
    # If "All" is selected, filter only by provincia
    df_x %>% filter(provincia == input$provincia_0)
  } else {
    # Otherwise, filter by both provincia and ambito
    df_x %>% filter(provincia == input$provincia_0 & sector == input$sector_0)
  }
})

reactive_seq_x <- reactive({
  data_x <- filtered_data_x()
  secuencia_prov_x <- seqdef(data_x,4:(63+12), alphabet = df_x.alphabet, states = df_x.scodes, 
                   labels = df_x.labels, xtstep = 4)
  cpal(secuencia_prov_x)<-c("#7FC97F" ,"#FDC086","#FFFF99","white")
  return (secuencia_prov_x)
                          })

output$seqPlot_x <- renderPlot({
    seqIplot(reactive_seq_x(), sortv = "from.start", with.legend = "right", 
             main = paste("Secuencia -", input$provincia_0), cex.legend = 0.7)
  })

######################################################################################################


filtered_data_barras <-reactive({
    data_long_provincias %>% filter(provincia == input$provincia_barras)})


reactive_barras <- reactive({
  data_provincia_barras <- filtered_data_barras()
  
  grafico_barras_provincia <- ggplot(data_provincia_barras, aes(x = fecha, y = value, fill = column)) +
  geom_bar(stat = "identity") +
  labs(x = "Fecha", y = "Value", fill = "Columns") +
  ggtitle(paste("Maestro de Grado por mes ", input$provincia_barras)) +
  scale_fill_manual(values = c("Titular" = "#7FC97F", "Suplente" = "#FDC086", "Interino" = "#FFFF99"),
                    labels =  c("Titular" = "Titular", "Suplente" = "Suplente", "Interino" = "Interino")) +
  theme_minimal() +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  grafico_barras_interactivo <- ggplotly(grafico_barras_provincia) 
  return(grafico_barras_interactivo)
 
})

output$grafico_barras_interactivo_provincia <- renderPlotly({reactive_barras()})


output$Total_provincia <- renderValueBox({valueBox(value=round(sum(filtered_data_barras()$value)/(60+12),0),
                                                 subtitle = paste ("Total",input$provincia_barras))})

output$interino_provincia <- renderValueBox({valueBox(value=round(mean(filtered_data_barras()%>% filter(Tipo == "Interino") %>% pull(value), na.rm = TRUE),0), subtitle = paste ("Promedio - Interino",input$provincia_barras))})


output$suplente_provincia <-  renderValueBox({valueBox(value=round(mean(filtered_data_barras()%>% filter(Tipo == "Suplente") %>% pull(value),na.rm=TRUE),0), subtitle = paste ("Promedio - Suplente",input$provincia_barras))})


output$titular_provincia <- renderValueBox({valueBox(value=round(mean(filtered_data_barras()%>% filter(Tipo == "Titular") %>% pull(value),na.rm=TRUE),0), subtitle = paste ("Promedio - Titular",input$provincia_barras))})



#########################################################################################################



filtered_data_rotacion <-reactive({
if (input$sector_rotacion == "All") {
    # If "All" is selected, filter only by provincia
    rotacion %>% filter(provincia == input$provincia_rotacion)
  } else {
    # Otherwise, filter by both provincia and ambito
    rotacion %>% filter(provincia == input$provincia_rotacion & sector == input$sector_rotacion)
  }
})

reactive_seq_rotacion <- reactive({
  data_rotacion <- filtered_data_rotacion()
  secuencia_prov_rotacion <- seqdef(data_rotacion,74:85, alphabet = rotacion.alphabet, states = rotacion.scodes, 
                   labels = rotacion.labels, xtstep = 5)
  cpal(secuencia_prov_rotacion)<-c("#7FC97F", "#BEAED4" ,"#FDC086", "#386CB0","#FFFF99" )
                

  return (secuencia_prov_rotacion)
                          })

output$seqPlot_rotacion <- renderPlot({
    seqdplot(reactive_seq_rotacion(),sortv = "from.start", with.legend = FALSE ,
             main = paste("Evol. Maestros Titulares ", input$provincia_rotacion), cex.legend = 0.7)
  })


reactive_df_sankey_rotacion <- reactive({
  # Create nodes and links data frames
  nodos_fil <- data.frame(name = c(
    "Maestro de Grado (Titular) en Escuela X",
    "Cambia de Puesto en la Escuela X",
    "Asciende a directivo en la Escuela X",
    "Abandona Sist. Educativo",
    "Deja la Escuela X por otra",
    "Mantiene su posicion en la Escuela X"
  ))

  links_fil <- data.frame(
    partida = rep(0, 5),
    objetivo = c(1, 2, 3, 4, 5),
    valores = c(
      sum(filtered_data_rotacion()$estado_final12 == "cambio_puesto"),
      sum(filtered_data_rotacion()$estado_final12 == "ascenso (dire_vice)"),
      sum(filtered_data_rotacion()$estado_final12 == "abandono sistema"),
      sum(filtered_data_rotacion()$estado_final12 == "otro (cambio o dejo la escuela)"),
      sum(filtered_data_rotacion()$estado_final12 == "sin cambio")
    )
  )

  # Calculate total for percentages
  total_fil <- sum(links_fil$valores)
  
  
  # calculamos las antiguedades
  
  antigueda_prom_estado_fil <- filtered_data_rotacion() %>%
  group_by(estado_final12) %>%
  summarize(avg_ant = mean(ANTIG))
  
  antigueda_prom_estado_fil$estado_final12 <- mappeado[antigueda_prom_estado_fil$estado_final12]
  
  links_fil <- links_fil %>%
  left_join(antigueda_prom_estado_fil, by = c('objetivo' = 'estado_final12'))

# Add tooltip with average age
  links_fil$tooltip <- paste("Ant Promedio:", round(links_fil$avg_ant, 2))
  
  #
  

  # Update node names with percentages
  nodos_fil$name <- c(
    "Maestro de Grado (Titular) en Escuela X",
    paste("Cambia de Puesto en la Escuela X (", round(100 * sum(filtered_data_rotacion()$estado_final12 == "cambio_puesto") / total_fil, 1), "%) - ",links_fil[links_fil$objetivo == 1, "tooltip"], sep = ""),
    paste("Asciende a directivo en la Escuela X (", round(100 * sum(filtered_data_rotacion()$estado_final12 == "ascenso (dire_vice)") / total_fil, 1), "%) - ",links_fil[links_fil$objetivo == 2, "tooltip"], sep = ""),
    paste("Abandona Sist. Educativo (", round(100 * sum(filtered_data_rotacion()$estado_final12 == "abandono sistema") / total_fil, 1), "%) - ",links_fil[links_fil$objetivo == 3, "tooltip"], sep = ""),
    paste("Deja la Escuela X por otra (", round(100 * sum(filtered_data_rotacion()$estado_final12 == "otro (cambio o dejo la escuela)") / total_fil, 1), "%) - ", links_fil[links_fil$objetivo == 4, "tooltip"],sep = ""),
    paste("Mantiene su posicion en la Escuela X (", round(100 * sum(filtered_data_rotacion()$estado_final12 == "sin cambio") / total_fil, 1), "%) - ", links_fil[links_fil$objetivo == 5, "tooltip"],sep = "")
  )

  # Return the data frames as a list
  list(links_fil = links_fil, nodos_fil = nodos_fil)
})

output$sankey_rotacion_provincia <- renderSankeyNetwork({
  # Retrieve reactive data
  data <- reactive_df_sankey_rotacion()
  
  # Define the color scale for nodes (optional)
  node_colors <- 'd3.scaleOrdinal(["#4CAF50","#386CB0","#FFFF99","#FDC086","#BEAED4","#7FC97F"])'
  
  
  
  # Create Sankey diagram with title
  sankey_fil <- sankeyNetwork(
    Links = data$links_fil,
    Nodes = data$nodos_fil,
    Source = "partida",
    Target = "objetivo",
    Value = "valores",
    NodeID = "name",
    units = "Docentes",
    fontSize = 12,
    nodeWidth = 40,
    colourScale = node_colors
  )

})




```
